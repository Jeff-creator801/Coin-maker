<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Coin Maker</title>

  <!-- Firebase client (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-auth-compat.js"></script>

  <!-- TonConnect UI (library via CDN) -->
  <script src="https://unpkg.com/@tonconnect/sdk@0.7.0/dist/tonconnect-sdk.min.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@2.0.8/dist/tonconnect-ui.min.js"></script>

  <style>
    :root{--bg:#071026;--card:#0b1330;--accent:#1ea7ff;--muted:#9fb3cf}
    body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#021027,#071026);color:#e6eef8}
    header{padding:16px;text-align:center;font-weight:700}
    .app{max-width:980px;margin:0 auto;padding-bottom:88px}
    .card{background:linear-gradient(180deg,#071526,#041028);border-radius:12px;padding:12px;margin:12px;border:1px solid rgba(255,255,255,0.03)}
    .row{display:flex;gap:8px}
    .field{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;width:100%}
    .btn{background:var(--accent);color:#021021;border:none;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .bottom{position:fixed;left:0;right:0;bottom:0;height:68px;background:#021021;display:flex;align-items:center;justify-content:space-around;padding:8px}
    .nav-btn{flex:1;margin:0 6px;padding:12px;border-radius:8px;background:#04182a;color:#9fb3cf;font-weight:700}
    .nav-btn.active{background:var(--accent);color:#021021}
    .muted{color:var(--muted);font-size:13px}
    .token{padding:10px;border-radius:10px;background:linear-gradient(180deg,#021826,#071028);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px}
  </style>
</head>
<body>
<header>Coin Maker — create & trade tokens</header>
<div class="app">
  <!-- HOME: token listing -->
  <section id="view-home" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Листинг токенов</strong><div class="muted">Пользовательские и листинговые токены</div></div>
      <div><button class="btn" onclick="loadTokens()">Обновить</button></div>
    </div>
    <div id="tokensContainer" style="margin-top:12px"></div>
  </section>

  <!-- CREATE -->
  <section id="view-create" class="card" style="display:none">
    <strong>Создать токен</strong>
    <div class="muted">Выберите тип и заполните форму</div>
    <select id="create_type" class="field" style="margin-top:8px">
      <option value="user">Пользовательский (динамическая цена)</option>
      <option value="listing">Листинговый (фиксированная цена)</option>
    </select>
    <input id="create_name" class="field" placeholder="Название" style="margin-top:8px" />
    <input id="create_ticker" class="field" placeholder="Тикер" style="margin-top:8px" />
    <div id="listingFields" style="display:none">
      <input id="create_supply" class="field" placeholder="Общий объём (totalSupply)" style="margin-top:8px" type="number" />
      <input id="create_price" class="field" placeholder="Цена за 1 токен (TON)" style="margin-top:8px" type="number" step="0.000000001" />
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" onclick="createToken()">Создать</button>
      <button class="btn ghost" onclick="clearCreate()">Очистить</button>
    </div>
    <div id="createResult" class="muted" style="margin-top:8px"></div>
  </section>

  <!-- MY TOKENS -->
  <section id="view-my" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Мои токены</strong><div class="muted">Токены, где вы владелец</div></div>
      <div id="tonconnectRoot"><!-- TonConnect button mounts here --></div>
    </div>
    <div style="margin-top:12px">
      <div class="muted">Адрес: <span id="connectedAddr">—</span></div>
    </div>
    <div id="myTokens" style="margin-top:12px"></div>
  </section>

  <!-- TRANSFERS -->
  <section id="view-transfers" class="card" style="display:none">
    <strong>Переводы (P2P)</strong>
    <div class="muted">Выберите токен, адрес и кол-во</div>
    <select id="transferToken" class="field" style="margin-top:8px"></select>
    <input id="transferTo" class="field" placeholder="TON адрес получателя" style="margin-top:8px" />
    <input id="transferAmount" class="field" placeholder="Количество" style="margin-top:8px" type="number" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" onclick="sendTransfer()">Отправить</button>
      <button class="btn ghost" onclick="loadBalances()">Мои балансы</button>
    </div>
    <div id="balancesArea" style="margin-top:12px"></div>
  </section>

  <!-- PROFILE -->
  <section id="view-profile" class="card" style="display:none">
    <strong>Профиль / Кошелёк</strong>
    <div class="muted" style="margin-top:8px">Подключение кошелька (TonConnect)</div>
    <div id="tonconnect"></div>
    <div style="margin-top:8px">Баланс TON (виртуально): <span id="virtTon">0</span></div>
    <div style="margin-top:8px"><button class="btn" onclick="disconnectWallet()">Отключить</button></div>
    <div id="txHistory" style="margin-top:12px"></div>
  </section>
</div>

<!-- Bottom nav -->
<div class="bottom">
  <button id="nav-home" class="nav-btn active" onclick="show('view-home')">Главная</button>
  <button id="nav-create" class="nav-btn" onclick="show('view-create')">Создать</button>
  <button id="nav-my" class="nav-btn" onclick="show('view-my')">Мои</button>
  <button id="nav-trans" class="nav-btn" onclick="show('view-transfers')">Переводы</button>
  <button id="nav-profile" class="nav-btn" onclick="show('view-profile')">Профиль</button>
</div>

<script>
/* ================= CONFIG ================= */
// Firebase client config (you shared earlier)
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA2mxa0BR-V7FtqCFxkXtSoOTGUFXbI4M4",
  authDomain: "gammaton-fdbfd.firebaseapp.com",
  databaseURL: "https://gammaton-fdbfd-default-rtdb.firebaseio.com",
  projectId: "gammaton-fdbfd",
  storageBucket: "gammaton-fdbfd.firebasestorage.app",
  messagingSenderId: "118045498245",
  appId: "1:118045498245:web:e4f46f8d8656500cc1c2ec"
};

// Server root (empty -> same origin)
const API_ROOT = '';

/* ================ INIT FIREBASE CLIENT ================ */
firebase.initializeApp(FIREBASE_CONFIG);
const rdb = firebase.database();

/* ================ TonConnect UI init (no manifest) ================ */
let tonConnectUI = null;
let connectedAccount = null;
(function initTon() {
  try {
    const UI = window.TON_CONNECT_UI || window.TonConnectUI || null;
    if (UI && UI.TonConnectUI) {
      tonConnectUI = new UI.TonConnectUI({ buttonRootId: 'tonconnect' });
    } else if (window.TON_CONNECT_UI && window.TON_CONNECT_UI.TonConnectUI) {
      tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({ buttonRootId: 'tonconnect' });
    } else {
      // fallback: try create with global
      try { tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({ buttonRootId: 'tonconnect' }); } catch(e){ console.warn('TonConnect UI init fallback failed', e); }
    }
  } catch (e) {
    console.warn('TonConnect init error', e);
  }
})();

/* ================ NAV ================ */
function show(id) {
  document.querySelectorAll('#view-home, #view-create, #view-my, #view-transfers, #view-profile').forEach(el => el.style.display = 'none');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(id).style.display = 'block';
  // highlight nav
  if (id === 'view-home') document.getElementById('nav-home').classList.add('active');
  if (id === 'view-create') document.getElementById('nav-create').classList.add('active');
  if (id === 'view-my') document.getElementById('nav-my').classList.add('active');
  if (id === 'view-transfers') document.getElementById('nav-trans').classList.add('active');
  if (id === 'view-profile') document.getElementById('nav-profile').classList.add('active');

  // lazy loads
  if (id === 'view-home') loadTokens();
  if (id === 'view-my') loadMyTokens();
  if (id === 'view-transfers') loadBalances();
  if (id === 'view-profile') loadTxHistory();
}

/* ================ CREATE -> show/hide listing fields ================ */
document.getElementById('create_type').addEventListener('change', e => {
  document.getElementById('listingFields').style.display = e.target.value === 'listing' ? 'block' : 'none';
});

/* ================ API helpers ================ */
async function api(path, opts = {}) {
  const res = await fetch(API_ROOT + path, opts);
  return res.json();
}

/* ================ TOKENS (LISTING) ================ */
async function loadTokens() {
  const container = document.getElementById('tokensContainer');
  container.innerHTML = '<div class="muted">Загрузка...</div>';
  // we also listen to realtime DB tokens to reflect server-side changes instantly
  rdb.ref('tokens').once('value').then(snap => {
    const data = snap.val() || {};
    const arr = Object.keys(data).map(k => ({ id: k, ...data[k] }));
    arr.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
    container.innerHTML = '';
    if (!arr.length) container.innerHTML = '<div class="muted">Токенов ещё нет</div>';
    arr.forEach(t => {
      const div = document.createElement('div');
      div.className = 'token';
      let body = `<div><div style="font-weight:700">${t.name} <span class="pill">${t.ticker}</span></div><div class="muted">Тип: ${t.type}</div></div>`;
      if (t.type === 'listing') {
        body += `<div style="text-align:right"><div>Цена: <b>${t.pricePerToken} TON</b></div><div class="muted">Осталось: ${t.remainingSupply}/${t.totalSupply}</div><div style="margin-top:8px"><button class="btn" onclick="startBuy('${t.id}')">Купить</button></div></div>`;
      } else {
        body += `<div style="text-align:right"><div>Цена: <b>${(Number(t.dynamicPrice)||0.1).toFixed(9)} TON</b></div><div class="muted">Выдано: ${t.supplyIssued||0}</div><div style="margin-top:8px"><button class="btn" onclick="startBuy('${t.id}')">Купить</button></div></div>`;
      }
      div.innerHTML = body;
      container.appendChild(div);
    });
  }).catch(e => { container.innerHTML = '<div class="muted">Ошибка загрузки токенов</div>'; console.error(e); });
}

/* ================ CREATE TOKEN ================ */
async function createToken() {
  const type = document.getElementById('create_type').value;
  const name = document.getElementById('create_name').value.trim();
  const ticker = document.getElementById('create_ticker').value.trim();
  if (!name || !ticker) return alert('Введите название и тикер');
  const payload = { type, name, ticker };

  if (type === 'listing') {
    const supply = Number(document.getElementById('create_supply').value || 0);
    const price = Number(document.getElementById('create_price').value || 0);
    if (!supply || !price) return alert('Укажите supply и цену');
    payload.totalSupply = supply;
    payload.pricePerToken = price;
  }

  const res = await api('/api/tokens/create', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if (res.ok) {
    document.getElementById('createResult').innerText = 'Создан токен: ' + res.id;
    clearCreate();
    loadTokens();
  } else {
    alert('Ошибка: ' + JSON.stringify(res));
  }
}
function clearCreate(){ document.getElementById('create_name').value=''; document.getElementById('create_ticker').value=''; document.getElementById('create_supply').value=''; document.getElementById('create_price').value=''; document.getElementById('createResult').innerText=''; }

/* ================ BUY FLOW ================ */
async function startBuy(tokenId) {
  // ensure user connected
  if (!connectedAccount) {
    // try connect
    try { await tonConnectUI.connectWallet(); }
    catch(e){ console.warn('connect fail', e); }
    if (!tonConnectUI) return alert('TonConnect UI unavailable');
    // try to get session account
    const session = tonConnectUI && tonConnectUI.tonConnect && tonConnectUI.tonConnect.wallets?.[0];
  }

  // get token
  const tokenSnap = await rdb.ref(`tokens/${tokenId}`).once('value');
  if (!tokenSnap.exists()) return alert('Токен не найден');
  const token = tokenSnap.val();

  const amount = Number(prompt('Сколько токенов купить?', '1'));
  if (!amount || amount <= 0) return;

  // create sale on server
  const r = await api(`/api/tokens/${tokenId}/buy`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ buyer: connectedAccount || null, amountTokens: amount }) });
  if (!r.ok) return alert('Ошибка создания заявки: ' + JSON.stringify(r));
  const { saleId, cost, receiver } = r;
  // show confirm
  if (!confirm(`Купить ${amount} ${token.ticker} за ${cost} TON? Перейти к оплате?`)) return;

  // send TON via TonConnect if available, else open deeplink
  const amountNano = (BigInt(Math.round(Number(cost) * 1e9))).toString();
  try {
    if (tonConnectUI && tonConnectUI.tonConnect && tonConnectUI.connected) {
      const txRes = await tonConnectUI.sendTransaction({ validUntil: Math.floor(Date.now()/1000) + 600, messages: [{ address: receiver, amount: amountNano }] });
      // try find txHash
      let txHash = txRes?.in_message?.hash || txRes?.inMessage?.hash || txRes?.hash || txRes?.messageHash || (Array.isArray(txRes) && (txRes[0]?.in_message?.hash || txRes[0]?.hash)) || null;
      // call server confirm
      const conf = await api(`/api/sales/${saleId}/confirm`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ txHash }) });
      if (conf.ok) {
        alert('Покупка подтверждена!');
        loadTokens(); loadBalances(); loadMyTokens();
      } else {
        alert('Покупка: транзакция отправлена. Подтверждение может занять время. Сервер ответил: ' + JSON.stringify(conf));
      }
    } else {
      // fallback deeplink
      window.location.href = `ton://transfer/${encodeURIComponent(receiver)}?amount=${String(cost)}&text=${encodeURIComponent('Buy '+amount+' '+token.ticker)}`;
      alert('Открыл кошелёк для оплаты. После отправки транзакции вернитесь и дождитесь подтверждения.');
    }
  } catch (e) {
    console.error('buy send error', e);
    alert('Ошибка при отправке транзакции: ' + (e.message || e));
  }
}

/* ================ TON Connect manual connect callback ================ */
// mount TonConnect button for profile and my tokens
(function mountTonBtn() {
  try {
    if (window.TON_CONNECT_UI && window.TON_CONNECT_UI.TonConnectUI) {
      // create instance for another root for convenience
      const ui = new window.TON_CONNECT_UI.TonConnectUI({ buttonRootId: 'tonconnectRoot' });
      // also keep main tonConnectUI variable (if not set)
      if (!tonConnectUI) tonConnectUI = ui;
      // listen for status change via tonConnect object if available
      if (ui.tonConnect) {
        ui.tonConnect.onStatusChange((payload) => {
          if (!payload) {
            connectedAccount = null;
            document.getElementById('connectedAddr').innerText = '—';
            return;
          }
          const acc = ui.tonConnect.account?.address || (payload?.account?.address);
          connectedAccount = acc;
          document.getElementById('connectedAddr').innerText = connectedAccount;
          loadBalances();
          loadMyTokens();
        });
      }
    }
  } catch(e) { console.warn('mount ton button error', e); }
})();

function disconnectWallet(){
  try { if (tonConnectUI && tonConnectUI.tonConnect) tonConnectUI.tonConnect.disconnect(); } catch(e){}
  connectedAccount = null;
  document.getElementById('connectedAddr').innerText = '—';
}

/* ================ P2P transfers ================ */
async function sendTransfer() {
  if (!connectedAccount) return alert('Подключите кошелёк в профиле');
  const tokenId = document.getElementById('transferToken').value;
  const to = document.getElementById('transferTo').value.trim();
  const amount = Number(document.getElementById('transferAmount').value);
  if (!tokenId || !to || !amount) return alert('Заполните поля');
  const res = await api('/api/transfer', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ tokenId, from: connectedAccount, to, amount })});
  if (res.ok) { alert('Перевод выполнен'); loadBalances(); }
  else alert('Ошибка перевода: ' + JSON.stringify(res));
}

/* ================ Balances & my tokens & history ================ */
async function loadBalances() {
  if (!connectedAccount) return;
  const res = await api('/api/balances/' + encodeURIComponent(connectedAccount));
  // show balances
  const area = document.getElementById('balancesArea'); area.innerHTML = '';
  if (!res || !res.length) area.innerHTML = '<div class="muted">Балансов нет</div>';
  else res.forEach(b => {
    const d = document.createElement('div'); d.className = 'token'; d.innerHTML = `<div>${b.tokenId}</div><div class="muted">Amount: ${b.amount}</div>`; area.appendChild(d);
  });
}

async function loadMyTokens() {
  // show tokens where owner === connectedAccount (owner stored as part of token)
  const snap = await rdb.ref('tokens').once('value');
  const data = snap.val() || {};
  const arr = Object.keys(data).map(k => ({ id: k, ...data[k] }));
  const mine = arr.filter(t => (t.owner && connectedAccount && t.owner.toLowerCase() === connectedAccount.toLowerCase()));
  const node = document.getElementById('myTokens'); node.innerHTML = '';
  if (!mine.length) node.innerHTML = '<div class="muted">У вас нет токенов</div>';
  else mine.forEach(t => {
    const el = document.createElement('div'); el.className = 'token'; el.innerHTML = `<div><strong>${t.name} (${t.ticker})</strong><div class="muted">${t.type}</div></div><div><button class="btn" onclick="viewToken('${t.id}')">Открыть</button></div>`; node.appendChild(el);
  });

  // also populate transfer token select
  const tokenSnap = await rdb.ref('tokens').once('value');
  const tokenObj = tokenSnap.val() || {};
  const sel = document.getElementById('transferToken'); sel.innerHTML = '<option value="">Выбери токен</option>';
  Object.keys(tokenObj).forEach(id => {
    const t = tokenObj[id];
    const opt = document.createElement('option'); opt.value = id; opt.innerText = `${t.name} (${t.ticker})`; sel.appendChild(opt);
  });
}

function viewToken(id) { alert('Открыть токен: ' + id); }

/* history */
async function loadTxHistory() {
  if (!connectedAccount) return;
  const res = await api('/api/history/' + encodeURIComponent(connectedAccount));
  const node = document.getElementById('txHistory'); node.innerHTML = '';
  if (!res || !res.length) node.innerHTML = '<div class="muted">Нет истории</div>';
  else res.forEach(it => {
    const div = document.createElement('div'); div.className='muted'; div.innerText = `${new Date(it.when).toLocaleString()} • ${it.type || it.note || ''} • ${it.amount || it.amountTokens || ''}`; node.appendChild(div);
  });
}

/* ================ initial load ================ */
loadTokens();
// also subscribe to tokens updates for live updates
rdb.ref('tokens').on('value', () => loadTokens());

// refresh some info periodically
setInterval(()=> {
  if (connectedAccount) { loadBalances(); loadMyTokens(); loadTxHistory(); }
}, 30000);

</script>
</body>
             </html> 
